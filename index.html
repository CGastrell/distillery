<!DOCTYPE html>
<meta charset="utf-8">
<title>The Distillery</title>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial;
  margin: 0;
  padding: 0;
}

h3 {
  margin: 0;
  padding: 0;
}

.head {
  font-size: 18px;
  line-height: 18px;
  padding: 20px 40px;
}

.description {
  font-size: 12px;
  color: #999;
  margin-left: 10px;
}

.sample {
  float: right;
  font-size: 12px;
}

.control-panel {
  font-size: 14px;
  line-height: 14px;
  padding: 15px 20px;
  background: #f0f0f0;
  border-top: solid 1px #ddd;
  border-bottom: solid 1px #ddd;
}

.note {
  color: #999;
  margin-right: 10px;
}

.files {
  display: inline-block;
  height: 30px;
  padding: 10px;
  margin: 0 20px;
  border: solid 1px #aaa;
  background: rgba(0, 0, 0, 0.1);
  box-shadow: inset 0px 1px 6px rgba(0, 0, 0, 0.2);
  border-radius: 3px;
}

.file {
  display: inline-block;
  padding: 8px 30px 8px 10px;
  margin-right: 10px;
  border: solid 1px #ccc;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 3px;
  border: solid 1px #333;
  color: white;
  position: relative;
}

.file .close {
  position: absolute;
  top: 5px;
  right: 5px;
  display: inline-block;
  border: solid 1px #ccc;
  padding: 4px;
  background: rgba(255, 0, 0, 0.5);
  width: 10px;
  height: 10px;
  border-radius: 3px;
  cursor: pointer;
}

.action.load {
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  background: rgba(255, 255, 255, 0.3);
  border: solid 1px rgba(0, 0, 0, 0.1);
  border-top: solid 1px rgba(255, 255, 255, 0.5);
  border-bottom: solid 1px rgba(0, 0, 0, 0.3);
  color: rgba(0, 0, 0, 0.3);
}

.argv {
  display: inline-block;
}

.option {
  display: inline-block;
  padding: 8px 10px 8px 0;
  margin-right: 10px;
  color: #666;
}

.action {
  display: inline-block;
  padding: 8px 10px;
  background: #666;
  color: white;
  border-radius: 4px;
  cursor: pointer;
  border: solid 1px #333;
}

.value {
  border: solid 1px #dedede;
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.03);
  padding: 8px 10px;
  margin-left: 6px;
  color: #333;
}

.action.download {
  float: right;
}

.map-container {
  position: absolute;
  left: 40px;
  right: 220px;
  top: 162px;
  bottom: 20px;
}

.map-controls {
  position: absolute;
  top: 152px;
  right: 10px;
  bottom: 10px;
  width: 150px;
  padding: 10px;
  border-left: solid 1px #ddd;
  background: rgba(255, 255, 255, 0.9);
}

.map-controls select {
  width: 100%;
}

.map {
  background: hsl(210, 50%, 70%);
  background-image: -webkit-radial-gradient(center 0, 100% 100%, hsl(210, 50%, 70%) 20%, hsl(210, 50%, 63%) 100%);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
}

.map-background {
  stroke: rgba(255, 255, 255, 0.4);
  stroke-width: 1px;
  fill: none;
}

.map path {
  fill: rgba(255, 255, 255, 0.08);
  stroke: hsl(210, 80%, 90%);
}

.map path:hover {
  fill: rgba(255, 255, 255, 0.18);
}

</style>

<div class="head">
  <span>The Distillery</span>
  <span class="description">A GUI for <a href="https://github.com/mbostock/topojson">TopoJSON</a></span>
  <button class="sample states">states</button>
  <button class="sample counties">counties</button>
  <button class="sample world">world</button>
</div>

<div class="control-panel">
  <div class="files">
    <span class="action load">+</span>
    <span class="note">Add GeoJSON file(s)</span>
    <input type="file" class="file-input" multiple="multiple" style="visibility: hidden;position: absolute;"></input>
  </div>
  <span>Simplification: </span>
  <div class="argv"></div>
  <span class="action download">Download TopoJSON</span>
</div>

<div class="map-container"></div>
<div class="map-controls"></div>
</div>

<script src="lib.js"></script>
<script src="javascripts/control-panel.js"></script>
<script>

window.URL = (window.URL || window.webkitURL);

var width = 500,
    height = 500;

var projection = d3.geo.mercator();

var path = d3.geo.path()
    .projection(projection);

var inputData,
    files = [],
    parsedFiles = [],
    topology,
    feature;

var argv = {
  quantization: 1e4,
  "simplify-proportion": 1
};

var mapContainer = d3.select(".map-container");

var mapControls = d3.select(".map-controls");

var svg = mapContainer.append("svg")
    .attr("class", "map")
    .attr("width", width)
    .attr("height", height);

var map = svg.append("g")
    .attr("transform", "translate(20, 20)");

var mapBackground = map.append("rect")
    .attr("class", "map-background");

var simplificationSlider = d3.select(".control-panel .argv")
  .append("input")
    .attr("type", "range")
    .attr("min", 50)
    .attr("max", 1000)
    .attr("step", 1)
    .attr("value", argv["simplify-proportion"] * 1000)
    .style("width", "400px")
    .on("change", function() {
      argv["simplify-proportion"] = +this.value / 1000; // Math.pow(10, -this.value);
      update();
    });

// Projection select
var availableProjections = ["mercator", "albersUsa", "equirectangular", "conicEqualArea", "conicConformal"];

var projectionSelect = mapControls.append("select")
    .on("change", function() {
      projection = (d3.geo[projectionSelect.node().value])();
      path = d3.geo.path().projection(projection);
      resetZoom();
      draw();
    });

var projections = projectionSelect.selectAll("option")
    .data(availableProjections)
  .enter().append("option")
    .text(function(d) { return d; })

var downloadButton = d3.select(".action.download")

downloadButton.on("click", function() {
  var url = window.URL.createObjectURL(new Blob(source.source, { "type" : "text\/json" }));

      var a = d3.select("body")
          .append('a')
          .attr("class", "svg-crowbar")
          .attr("download", filename + ".svg")
          .attr("href", url)
          .style("display", "none");

      a.node().click();

      setTimeout(function() {
        window.URL.revokeObjectURL(url);
      }, 10);
})



function processFiles() {
  var options = {
    "coordinate-system": "auto", // will be assigned by topojson.topology
    "quantization": argv.quantization
  };
  var geoFeatures = {};

  files.forEach(function(f) {
    // Bring back original geojson
    f.json = JSON.parse(f.content);
    geoFeatures[f.name] =  f.json;
  });
  // Convert and merge GeoJSON features into a TopoJSON topology.
  topology = topojson.topology(geoFeatures, options);

  // Simplify.
  if (+argv["simplify-proportion"] > 0) topojson.simplify(topology, {
    "coordinate-system": options["coordinate-system"],
    "retain-proportion": +argv["simplify-proportion"]
  });

  // Remove empty (or tiny) features.
  topojson.filter(topology, {
    "coordinate-system": options["coordinate-system"],
    "minimum-area": 0
  });

  files.forEach(function(f) {
    f.feature = topojson.feature(topology, topology.objects[f.name]);
  });

}

function addJSON(j, filename) {
  files.forEach(function(f, i) {
    if (f.name === filename) {
      throw "File name already exists"
    };
  })
  var file = {
    name: filename
  };
  if (j.type === "Topology") {
    // Is TopoJSON
    // TODO convert to geojson and cache that result as a string into file.content
  } else {
    file.json = j;
    file.content = JSON.stringify(j);
  }
  files.push(file);
  processFiles();
  resetZoom();
  draw();

}



function removeFile(name) {
  var index;
  files.forEach(function(f, i) {
    if (f.name === name) { index = i; };
  });
  files.splice(index, 1);
  processFiles();
  draw();
}

function resetZoom() {
  if (files.length) {
    var feature = files[files.length - 1].feature;
    projection
        .scale(1)
        .translate([0, 0]);

    var b = path.bounds(feature),
        s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

    projection
        .scale(s)
        .translate(t);
  };

}

function draw() {
  var fileContainer = d3.select(".files").selectAll(".file")
      .data(files, function(d) { return d.name; });

  var newFile = fileContainer.enter().insert("div", ".action")
      .attr("class", "file");

  newFile.append("span")
      .text(function(d){ return d.name; });

  newFile.append("span").attr("class", "close")
      .text("X")
      .on("click", function(d) {
        removeFile(d.name);
      });

  fileContainer.exit().remove();


  d3.select(".files .note").style("display", files.length ? "none" : null );


  var f = map.selectAll(".file")
      .data(files, function(d) { return d.name; });

  f.enter().append("g").attr("class", "file");
  f.exit().remove();

  f.each(function(d) {
    var g = d3.select(this);
    var feature = g.selectAll("path")
        .data(function(d) { return d.feature.features }); // TODO assumes feature is a FeatureCollection
    feature.enter()
      .append("path")
      .append("title")
        .text(function(d) { return d.id; });
    feature.exit().remove();
    feature.attr("d", path);
  })
}

//
// Events
//

// Update argv

function update() {
  processFiles();
  draw();
}

// Window resize
window.onresize = function() {
  resize();
  draw();
};

function resize() {
  var bbox = mapContainer.node().getBoundingClientRect();
  width = bbox.width - 40;
  height = bbox.height - 40;
  svg.attr("width", bbox.width).attr("height", bbox.height);
  mapBackground.attr("width", width).attr("height", height);
  resetZoom();
}

resize();

//
// File Inputs
//

// File chooser
var fileInput = d3.select(".file-input").on("change", function(evt) {
  handleFiles(this.files)
});

d3.select(".action.load").on("click", function() {
  fileInput.node().click();
})

// Drag and drop
var dropTarget = document;

dropTarget.addEventListener("dragenter", dropKill, false);
dropTarget.addEventListener("dragexit", dropKill, false);
dropTarget.addEventListener("dragover", dropKill, false);
dropTarget.addEventListener("drop", drop, false);

function dropKill(evt) {
  evt.stopPropagation();
  evt.preventDefault();
}

function drop(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  var files = evt.dataTransfer.files;
  if (files.length > 0) handleFiles(files);
}

function handleFiles(files) {
  Array.prototype.slice.call(files).forEach(function(file) {
    var fileName = file.name.split(".")[0],
        reader = new FileReader();
    reader.onload = function(evt) {
      addJSON(JSON.parse(evt.target.result), fileName);
    }
    reader.readAsText(file);
  });
}


//
// Samples
//

d3.select(".sample.states").on("click", function(){
  d3.json("samples/geojson/states.json", function(error, json) {
    addJSON(json, "states");
  })
});

d3.select(".sample.counties").on("click", function(){
  d3.json("samples/geojson/counties.json", function(error, json) {
    addJSON(json, "counties");
  })
});

d3.select(".sample.world").on("click", function(){
  d3.json("samples/geojson/world.json", function(error, json) {
    addJSON(json, "world");
  })
});

</script>
