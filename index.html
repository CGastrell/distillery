<!DOCTYPE html>
<meta charset="utf-8">
<title>The Distillery</title>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial;
  margin: 0;
  padding: 0;
}

h3 {
  margin: 0;
  padding: 0;
}

.header {
  padding: 15px 20px;
  font-size: 14px;
  line-height: 14px;
  background: #f0f0f0;
  border-top: solid 1px #ddd;
  border-bottom: solid 1px #ddd;
  width: 100%;
}

.header td {
  padding: 0 10px;
  vertical-align: top;
}

.branding {
  font-family: Georgia;
  color: rgb(220, 220, 220);
  text-shadow: -1px -1px 0.5px rgba(0, 0, 0, 0.2), 1px 1px 0.5px rgba(255, 255, 255, 0.7);
  font-size: 26px;
  line-height: 48px;
  width: 180px;
}

.description {
  font-size: 12px;
  color: #999;
}

.note {
  color: #999;
}

.input {
  width: 200px;
}

.files {
  height: 26px;
  width: 200px;
  padding: 8px 0px 8px 48px;
  border: solid 1px rgba(0,0,0,0.15);
  background: rgba(0, 0, 0, 0.05);
  box-shadow: inset 0px 1px 8px rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  line-height: 26px;
  position: relative;
}

.action.load {
  position: absolute;
  left: 4px;
  top: 4px;
  height: 16px;
  line-height: 12px;
  font-size: 20px;
  width: 16px;
  display: block;
}

.file {
  display: inline-block;
  padding: 8px 30px 8px 10px;
  margin-right: 10px;
  background: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
  color: rgba(0, 0, 0, 0.8);
  white-space: nowrap;
  position: relative;
  line-height: 10px;
}

.file .close {
  color: rgba(255, 255, 255, 0.4);
  position: absolute;
  top: 4px;
  right: 4px;
  display: inline-block;
  padding: 4px;
  background: rgba(0, 0, 0, 0.1);
  width: 10px;
  height: 10px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 10px;
  line-height: 10px;
  text-align: center;
}

.simplify {
  border-right: solid 1px #ddd;
  border-left: solid 1px #ddd;
  position: relative;
}

.simplify .note {
  position: absolute;
  right: 10px;
  top: 4px;
  font-size: 12px;
}

.simplify p {
  margin: 4px 0 2px;
}

.simplify input {
  margin-top: 8px;
}

.output {
  width: 140px;
}

.action.download {
  display: block;
  height: 26px;
  width: 140px;
  line-height: 26px;
  padding: 10px 20px;
}




.argv {
  display: inline-block;
}

.option {
  display: inline-block;
  padding: 8px 10px 8px 0;
  margin-right: 10px;
  color: #666;
}

.action {
  text-decoration: none;
  text-align: center;
  padding: 8px 10px;
  color: rgba(0, 0, 0, 0.5);
  border-radius: 4px;
  cursor: pointer;
  text-decoration: none;
  background: #666;
  background-image: -webkit-linear-gradient(bottom, rgb(243,243,243) 0%, rgb(238,238,238) 36%, rgb(250,250,250) 72%);
  border: solid 1px rgba(0, 0, 0, 0.2);
  /*border-top: solid 1px white;*/
  border-bottom: solid 1px rgba(0,0,0,0.3);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}


.map-container {
  position: absolute;
  right: 40px;
  left: 240px;
  top: 110px;
  bottom: 20px;
}

.map-controls {
  position: absolute;
  top: 110px;
  left: 30px;
  bottom: 20px;
  width: 170px;
  padding-right: 10px;
  background: rgba(255, 255, 255, 0.9);
}

.map-controls select {
  width: 100%;
}

.map {
  background: hsl(210, 50%, 70%);
  background-image: -webkit-radial-gradient(center 0, 100% 100%, hsl(210, 50%, 70%) 20%, hsl(210, 50%, 63%) 100%);
  background-image: -webkit-radial-gradient(center 0, 100% 100%, rgb(255, 251, 242) 20%, rgb(247, 241, 223) 100%);
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
}

.map-background {
  stroke: rgba(0, 0, 0, 0.2);
  stroke-width: 1px;
  fill: none;
}

.map path {
  fill: rgba(0, 0, 0, 0.08);
  stroke: rgba(0, 0, 0, 0.2);
}

.map path:hover {
  fill: rgba(0, 0, 0, 0.14);
}

</style>

<table class="header">
  <tr>
    <td class="branding">
      <span>The Distillery</span><br>
    </td>
    <td class="input">
      <div class="files">
        <span class="note">Upload GeoJSON file(s)</span>
        <a class="action load">+</a>
        <input type="file" class="file-input" multiple="multiple" style="visibility: hidden;position: absolute;"></input>
      </div>
    </td>
    <td class="simplify">
      <p>Simplify Geometry</p>
      <span class="note"><span class="value"></span> percent of points retained</span>
      <input type="range" class=""></input>
    </td>
    <td class="output">
      <a class="action download">Download TopoJSON</a>
    </td>
  </tr>
</table>

<div class="map-container"></div>
<div class="map-controls">
  <p>Projection</p>
  <select class="projection"></select>
  <p>Zoom</p>
  <button>+</button>
  <button>-</button>
  <p>Load Sample Data</p>
  <button class="sample states">states</button><br>
  <button class="sample counties">counties</button><br>
  <button class="sample world">world</button>
  <p>About</p>
  <p class="description">This is a simple GUI for <a href="https://github.com/mbostock/topojson">TopoJSON</a></p>
  <p class="description">Fork me on <a href="https://github.com/shancarter/distillery">Github</a></p>

</div>
</div>

<script src="lib.js"></script>
<script src="javascripts/control-panel.js"></script>
<script>

window.URL = (window.URL || window.webkitURL);

var width = 500,
    height = 500;

var format = d3.format("1f")

var projection = d3.geo.mercator();

var path = d3.geo.path()
    .projection(projection);

var inputData,
    files = [],
    parsedFiles = [],
    topology,
    feature;

var argv = {
  quantization: 1e4,
  "simplify-proportion": 1
};

var mapContainer = d3.select(".map-container");

var mapControls = d3.select(".map-controls");

var svg = mapContainer.append("svg")
    .attr("class", "map")
    .attr("width", width)
    .attr("height", height);

var map = svg.append("g")
    .attr("transform", "translate(20, 20)");

var mapBackground = map.append("rect")
    .attr("class", "map-background");

var simplificationSlider = d3.select(".simplify input")
    .attr("type", "range")
    .attr("min", 10)
    .attr("max", 1000)
    .attr("step", 1)
    .attr("value", argv["simplify-proportion"] * 1000)
    .style("width", "100%")
    .on("change", function() {
      argv["simplify-proportion"] = +this.value / 1000;
      d3.select(".simplify .value").text(this.value / 10)
      update();
    });

// Projection select
var availableProjections = ["mercator", "albersUsa", "equirectangular", "conicEqualArea", "conicConformal"];

var projectionSelect = mapControls.select(".projection")
    .on("change", function() {
      projection = (d3.geo[projectionSelect.node().value])();
      path = d3.geo.path().projection(projection);
      resetZoom();
      draw();
    });

var projections = projectionSelect.selectAll("option")
    .data(availableProjections)
  .enter().append("option")
    .text(function(d) { return d; })

var downloadButton = d3.select(".action.download")

downloadButton.on("mouseover", function() {
  if (files.length) {
    var url = window.URL.createObjectURL(new Blob([JSON.stringify(topology)], { "type" : "application\/json" }));
    downloadButton
        .attr("download", files.map(function(f) { return f.name; }).join("-") + ".json")
        .attr("href", url)
        .on("mouseout", function(){
          setTimeout(function() {
            window.URL.revokeObjectURL(url);
          }, 10);
        });
  }
});



function processFiles() {
  var options = {
    "coordinate-system": "auto", // will be assigned by topojson.topology
    "quantization": argv.quantization
  };
  var geoFeatures = {};

  files.forEach(function(f) {
    // Bring back original geojson
    f.json = JSON.parse(f.content);
    geoFeatures[f.name] =  f.json;
  });
  // Convert and merge GeoJSON features into a TopoJSON topology.
  topology = topojson.topology(geoFeatures, options);

  // Simplify.
  if (+argv["simplify-proportion"] > 0) topojson.simplify(topology, {
    "coordinate-system": options["coordinate-system"],
    "retain-proportion": +argv["simplify-proportion"]
  });

  // Remove empty (or tiny) features.
  topojson.filter(topology, {
    "coordinate-system": options["coordinate-system"],
    "minimum-area": 0
  });

  files.forEach(function(f) {
    f.feature = topojson.feature(topology, topology.objects[f.name]);
  });

}

function addJSON(j, filename) {
  files.forEach(function(f, i) {
    if (f.name === filename) {
      throw "File name already exists"
    };
  })
  var file = {
    name: filename
  };
  if (j.type === "Topology") {
    // Is TopoJSON
    // TODO convert to geojson and cache that result as a string into file.content
  } else {
    file.json = j;
    file.content = JSON.stringify(j);
  }
  files.push(file);
  processFiles();
  resetZoom();
  draw();

}



function removeFile(name) {
  var index;
  files.forEach(function(f, i) {
    if (f.name === name) { index = i; };
  });
  files.splice(index, 1);
  processFiles();
  draw();
}

function resetZoom() {
  if (files.length) {
    var feature = files[files.length - 1].feature;
    projection
        .scale(1)
        .translate([0, 0]);

    var b = path.bounds(feature),
        s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

    projection
        .scale(s)
        .translate(t);
  };

}

function draw() {
  var fileContainer = d3.select(".files").selectAll(".file")
      .data(files, function(d) { return d.name; });

  var newFile = fileContainer.enter().insert("div", ".action")
      .attr("class", "file");

  newFile.append("span")
      .text(function(d){ return d.name; });

  newFile.append("span").attr("class", "close")
      .text("X")
      .on("click", function(d) {
        removeFile(d.name);
      });

  fileContainer.exit().remove();


  d3.select(".files .note").style("display", files.length ? "none" : null );


  var f = map.selectAll(".file")
      .data(files, function(d) { return d.name; });

  f.enter().append("g").attr("class", "file");
  f.exit().remove();

  f.each(function(d) {
    var g = d3.select(this);
    var feature = g.selectAll("path")
        .data(function(d) { return d.feature.features }); // TODO assumes feature is a FeatureCollection
    feature.enter()
      .append("path")
      .append("title")
        .text(function(d) { return d.id; });
    feature.exit().remove();
    feature.attr("d", path);
  })
}

//
// Events
//

// Update argv

function update() {
  processFiles();
  draw();
}

// Window resize
window.onresize = function() {
  resize();
  draw();
};

function resize() {
  var bbox = mapContainer.node().getBoundingClientRect();
  width = bbox.width - 40;
  height = bbox.height - 40;
  svg.attr("width", bbox.width).attr("height", bbox.height);
  mapBackground.attr("width", width).attr("height", height);
  resetZoom();
}

resize();

//
// File Inputs
//

// File chooser
var fileInput = d3.select(".file-input").on("change", function(evt) {
  handleFiles(this.files)
});

d3.select(".action.load").on("click", function() {
  fileInput.node().click();
})

// Drag and drop
var dropTarget = document;

dropTarget.addEventListener("dragenter", dropKill, false);
dropTarget.addEventListener("dragexit", dropKill, false);
dropTarget.addEventListener("dragover", dropKill, false);
dropTarget.addEventListener("drop", drop, false);

function dropKill(evt) {
  evt.stopPropagation();
  evt.preventDefault();
}

function drop(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  var files = evt.dataTransfer.files;
  if (files.length > 0) handleFiles(files);
}

function handleFiles(files) {
  Array.prototype.slice.call(files).forEach(function(file) {
    var fileName = file.name.split(".")[0],
        reader = new FileReader();
    reader.onload = function(evt) {
      addJSON(JSON.parse(evt.target.result), fileName);
    }
    reader.readAsText(file);
  });
}


//
// Samples
//

d3.select(".sample.states").on("click", function(){
  d3.json("samples/geojson/states.json", function(error, json) {
    addJSON(json, "states");
  })
});

d3.select(".sample.counties").on("click", function(){
  d3.json("samples/geojson/counties.json", function(error, json) {
    addJSON(json, "counties");
  })
});

d3.select(".sample.world").on("click", function(){
  d3.json("samples/geojson/world.json", function(error, json) {
    addJSON(json, "world");
  })
});

</script>
