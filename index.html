<!DOCTYPE html>
<meta charset="utf-8">
<title>The Distillery</title>
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial;
  margin: 0;
  padding: 0;
}

h3 {
  margin: 0;
  padding: 0;
}

.head {
  font-size: 18px;
  line-height: 18px;
  padding: 20px;
}

.sample {
  float: right;
  font-size: 12px;
}

.control-panel {
  font-size: 14px;
  line-height: 14px;
  padding: 15px 20px;
  background: #f0f0f0;
  border-top: solid 1px #ddd;
  border-bottom: solid 1px #ddd;
}

.argv {
  display: inline-block;
}

.option {
  display: inline-block;
  padding: 8px 10px 8px 0;
  margin-right: 10px;
  color: #666;
}

.action {
  display: inline-block;
  padding: 8px 10px;
  margin: 0 10px 0 0;
  background: #666;
  color: white;
  border-radius: 4px;
  cursor: pointer;
  border: solid 1px #333;
}

.action:hover {
  border-color: red;
}

.value {
  border: solid 1px #dedede;
  border-radius: 4px;
  background: rgba(0, 0, 0, 0.03);
  padding: 8px 10px;
  margin-left: 6px;
  color: #333;
}

.save {
  float: right;
}

.map-container {
  position: absolute;
  left: 10px;
  right: 10px;
  top: 141px;
  bottom: 10px;
}

.map-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 150px;
  padding: 10px;
  border: solid 1px #ddd;
  background: rgba(255, 255, 255, 0.9);
}

.map-controls select {
  width: 100%;
}

.map {
}

.map path {
  fill: rgba(255, 200, 200, 0.4);
  stroke: red;
}

</style>

<div class="head">
  <span>TopoJSON Distillery</span>
  <button class="sample states">states</button>
  <button class="sample counties">counties</button>
  <button class="sample world">world</button>
</div>

<div class="control-panel">
  <span class="action load">Load file</span>
  <div class="argv"></div>
  <span class="action save">Save</span>
</div>

<div class="map-container"></div>
</div>

<script src="lib.js"></script>
<script src="javascripts/control-panel.js"></script>
<script>

var width = 500,
    height = 500;

var projection = d3.geo.mercator();

var path = d3.geo.path()
    .projection(projection);

var inputData,
    files = [],
    parsedFiles = [],
    topology,
    feature;

var argv = {
  quantization: 1e4,
  simplification: 1e-5
};

var simplificationSlider = d3.select(".control-panel .argv")
  .append("input")
    .attr("type", "range")
    .attr("min", 1e-7)
    .attr("max", 1e-4)
    .attr("step", 1e-7)
    .attr("value", argv.simplification)
    .style("width", "600px")
    .on("change", function() {
      argv.simplification = +this.value; // Math.pow(10, -this.value);
      update();
    })

var mapContainer = d3.select(".map-container");

var mapControlsContainer = mapContainer.append("div")
    .attr("class", "map-controls");

var svg = mapContainer.append("svg")
    .attr("class", "map")
    .attr("width", width)
    .attr("height", height);

var availableProjections = ["mercator", "albersUsa", "equirectangular", "conicEqualArea", "conicConformal"];

var projectionSelect = mapControlsContainer.append("select")
    .on("change", function() {
      projection = (d3.geo[projectionSelect.node().value])();
      path = d3.geo.path().projection(projection);
      resetZoom();
      draw();
    });

var projections = projectionSelect.selectAll("option")
    .data(availableProjections)
  .enter().append("option")
    .text(function(d) { return d; })

function processFiles() {
  files.forEach(function(f) {

    // Bring back original geojson
    f.json = JSON.parse(f.content);

    var options = {
      "coordinate-system": "auto", // will be assigned by topojson.topology
      "quantization": argv.quantization
    };

    // Convert and merge GeoJSON features into a TopoJSON topology.
    var o = {}
    o[f.name] =  f.json;
    f.topology = topojson.topology(o, options);

    // Simplify.
    if (+argv.simplification > 0) topojson.simplify(f.topology, {
      "coordinate-system": options["coordinate-system"],
      "minimum-area": +argv.simplification
    });

    // Remove empty (or tiny) features.
    topojson.filter(f.topology, {
      "coordinate-system": options["coordinate-system"],
      "minimum-area": +argv.simplification || 0
    });

    f.feature = topojson.feature(f.topology, f.topology.objects[f.name]);
  });
}

function addJSON(j, filename) {
  var file = {
    name: filename
  };
  if (j.type === "Topology") {
    // Is TopoJSON
    // TODO convert to geojson and cache that result as a string into file.content
  } else {
    file.json = j;
    file.content = JSON.stringify(j);
  }
  files.push(file);
  processFiles();
  resetZoom();
  draw();

}

function removeFile(i) {
  // TODO remove file by index
}

function resetZoom() {
  if (files.length) {
    var feature = files[files.length - 1].feature;
    projection
        .scale(1)
        .translate([0, 0]);

    var b = path.bounds(feature),
        s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

    projection
        .scale(s)
        .translate(t);
  };

}

function draw() {
  files.forEach(function(f) {
    var feature = svg.selectAll("path")
        .data(f.feature.features); // TODO assumes feature is a FeatureCollection
    feature.enter().append("path");
    feature.exit().remove();
    feature.attr("d", path);
  })
}

//
// Events
//

// Update argv

function update() {
  processFiles();
  draw();
}

// Window resize
window.onresize = function() {
  resize();
  draw();
};

function resize() {
  var bbox = mapContainer.node().getBoundingClientRect();
  width = bbox.width;
  height = bbox.height;
  svg.attr("width", width).attr("height", height);
  resetZoom();
}

resize();


// Drag and drop
var dropTarget = document;

dropTarget.addEventListener("dragenter", dropKill, false);
dropTarget.addEventListener("dragexit", dropKill, false);
dropTarget.addEventListener("dragover", dropKill, false);
dropTarget.addEventListener("drop", drop, false);

function dropKill(evt) {
  evt.stopPropagation();
  evt.preventDefault();
}

function drop(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  var files = evt.dataTransfer.files;
  if (files.length > 0) handleFiles(files);
}

function handleFiles(files) {
  var file = files[0];
  var reader = new FileReader();
  reader.onload = handleReaderLoad;
  reader.readAsText(file);
}

function handleReaderLoad(evt) {
  addFile(evt.target.result, "anonymous");
}

//
// Samples
//

d3.select(".sample.states").on("click", function(){
  d3.json("samples/geojson/states.json", function(error, json) {
    addJSON(json, "states");
  })
});

d3.select(".sample.counties").on("click", function(){
  d3.json("samples/geojson/counties.json", function(error, json) {
    addJSON(json, "counties");
  })
});

</script>
